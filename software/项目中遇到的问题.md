# 问题总结

该文档记录在项目开发中遇到的各种问题，问题难度最高5星，每个问题的解决时间都是超过半天时间以上的，或者存在疑惑时间在1天以上的

目录

[问题1 如何重构由 dva + roadhog 构建的前端项目](#问题1-如何重构由-dva-+-roadhog-构建的前端项目)  
[问题2 通过 post 提交数据是否只能是 json 数据](#问题2-通过-post-提交数据是否只能是-json-数据)  
[问题3 自动滚动动画](#问题3-自动滚动动画)  
[问题4 import 异步加载先后顺序问题](#问题4-import-异步加载先后顺序问题)  
[问题5 通过浏览器打开uri下载文件uri编码问题](#问题5-通过浏览器打开uri下载文件uri编码问题)  
[问题6 滚动联动](#问题6-滚动联动)  

## 问题1 如何重构由 dva + roadhog 构建的前端项目

难度：**5星**

frontend developer: heyunjiang

startTime: 2018.8.22

update: 2018.9.14

背景：最开始使用的是 `ant-admin` 项目，当初还只有1000多颗 star ，使用的是 `roadhog 1.0` + `dva 1.0` + `antd 2.3` + `react 15.0` 版本，并且其中涉及更多的版本依赖，现在这些技术都已经升级了许多版本了，单独升级老版本某一项是会影响项目的运行的，但是如果全部升级或者部分升级，又会遇到很多问题，项目运行不成功，这源于蚂蚁的 roadhog、 antd 向下兼容不是很好， antd 3 要求支持 react 16 及以上，但是老项目有许多其他包要求是 react 16 以下的版本，所以干脆搞一个前端项目重构，把蚂蚁的这些封装好的开发环境给拆分了，自己做一套开发环境，要求能随时跟上技术的跟新而更新

重构部分：

开发环境： roadhog -> webpack 4

dva -> react-router + redux-saga + redux + react-redux

antd 2.x -> antd 3.x

## 问题2 通过 post 提交数据是否只能是 json 数据

难度：**1星**

time: 2018.9.29

答：自然不是。前面一直以为通过 post 提交的数据，只能是 `"{'hello':'world'}"` 这种 json 字符串格式的内容。后面自己在做文件上传的时候，需要用到 `FormData` 上传文件，这个可不是 json 字符串。

FormData 包含文件、blob、字符串这3种类型，其他类型如 number ，都会强制转换成 string 。

使用 post 方式提交内容，可以提交 object、array、FormData 等。

## 问题3 自动滚动动画

time: 2018.10.14

难度：**3星**

问题描述：做自动滚动动画，滚动距离动态获取，所以不能直接在 css 里面写死。原本想通过控制滚动条，让滚动条随时间滚动，但是这个只能通过 js `element.scrollTop` 实现，没有对应的 css 样式可以控制滚动条滚动。怎么才能合理实现这个滚动效果呢？(自己对动画这块不是很熟悉，所以花的时间多些)

解决方案：不通过控制滚动条方式实现，因为 `element.scrollTop` 动画绘制看起来很笨拙。通过 `element.animate()` 执行动画，添加的动画属性为 `transform: 'translateY()'` 实现

```javascript
timer = setTimeout(()=>{
    // element.scrollTop = scrollNumber
    element.firstElementChild.animate([
            { transform: 'translateY(0px)' },
            { transform: 'translateY(-'+scrollNumber+'px)' }
        ], {
            duration: scrollTime,
            fill: 'forwards'
        }
    )
}, delayTime)
```

学到了

1. element.animate()
2. 自执行滚动动画执行原理

## 问题4 import 异步加载先后顺序问题

time: 2018.10.16

难度：**2星**

问题描述：在使用 react-loadable + import() 做代码拆分时，需要对 model + route 实现异步加载，但是要求 model 要在 route 运行时已经运行了，即相应的 state 已经插入到 state tree 中了。

原有异步加载方案

```javascript
loader: () => {
    if(item === 'skin' || item === 'api') {} else {
        import('./models/'+item).then(response => {
            registerModel(app, response.default);
        })
    }
    const result = import('./routes/'+item+'/').then(response => response)
    result.catch(e => {
        // 模块加载出错处理
        console.log(e)
    })
    return result
}
```

改良后的方案： 采用 Promise.all 保证所有模块已经加载完毕再返回对应组件的 promise

```javascript
loader: () => {
    const promises = []
    if(item === 'skin' || item === 'api') {} else {
        promises.push(import('./models/'+item).then(response => {
            registerModel(app, response.default);
        }))
    }
    promises.push(import('./routes/'+item+'/'))
    const result = Promise.all(promises).then(response => response[1])
    result.catch(e => {
        // 模块加载出错处理
        console.log(e)
    })
    return result
}
```

## 问题5 通过浏览器打开uri下载文件uri编码问题

time: 2018.10.31

难度：**3星**

问题描述：下载文件，都是通过浏览器发送 get 请求，访问服务器端一个方法，该方法会返回文档流，然后下载。现在问题是，浏览器发送的 get 请求中，如果这个 uri 包含空格，chrome 和 ie 都能正确处理它，但是 firefox 会截取空格之前的，所以不能获取到

问题原因：浏览器地址栏中出现的 uri ，在RFC3986文档规定中，只允许包含`英文字母`、`数字`、`-_.~`、`所有保留字符`。

> 保留字符：`!` 、`*` 、`'` 、`(` 、`)` 、`;` 、`:` 、`@` 、`&` 、`=` 、`+` 、`$` 、`,` 、`/` 、`?` 、`#` 、`[` 、`]`  
> 不安全字符：空格、""、<>、{}、|、^、`、~

解决方案：在 uri 中将空格转义，写成 + 或者 `%2B` ，或者 `%20`

> 如果文件能正确下载，但是文件名不正确，在 chrome 和 ie 中都正常，就 firefox 不正常。因为文件名中存在空格，发起下载的 uri 能正确访问到服务器，但是服务器返回的文档流数据中，文件名包含空格，只是在 firefox 中不能被正确识别。

## 问题6 滚动联动

time: 2018.11.05

难度：**4星**

问题描述：滚动联动问题。在内嵌滚动滚动的同时，带动了外部滚动条的滚动，让页面不流畅，体验差。浏览器报错提示 `Unable to preventDefault inside passive event listener due to target being treated as passive`。

问题分析：项目任务，在移动端才存在滚动联动问题，pc 端不存在。在内嵌滚动中，每个 item 绑定了 `touch` 事件，其包裹盒子绑定了 `drag` 事件，然后在整体 container 中，绑定了 `scroll` 事件实现鼠标滚动功能及移动端 `touchmove` 功能。  
浏览器报这个错，是因为内嵌滚动。不能使用修改 `passive` 解决这个问题，因为这个事件是在第三方库中实现的

> 原本嵌套滚动是不存在滚动联动问题，什么情况才能出现呢？

解决方案：给目标滚动容器添加 `touch-action: none;`

引申学习：

1. touch-action 这个属性有什么用？ [point-events](../css/深入css-常见知识归纳#5-pointer-events)
2. passive event 是什么？ [深入浏览器-dom](../browser/深入浏览器-dom.md)
